name: ðŸ”¨ Build ESP32 Firmware

on:
  push:
    branches: [ main, feature/* ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build:
    name: Build CEO Hub Firmware
    runs-on: ubuntu-latest

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4.1.1

    - name: ðŸ Set up Python
      uses: actions/setup-python@0a5c61591373683505ea898e09a3ea4f39ef2b9c  # v5.0.0
      with:
        python-version: '3.11'

    - name: ðŸ“¦ Install PlatformIO
      run: |
        python -m pip install --upgrade pip
        pip install platformio

    - name: ðŸ” Show PlatformIO version
      run: pio --version

    - name: ðŸ“¥ Install dependencies
      run: pio pkg install

    - name: ðŸ”¨ Build firmware
      run: pio run

    - name: ðŸ“Š Show build info
      run: |
        ls -lh .pio/build/esp32dev/
        pio run --target size

    - name: ðŸ“¤ Upload firmware artifacts
      uses: actions/upload-artifact@5d5d22a31266ced268874388b861e4b58bb5c2f3  # v4.3.1
      with:
        name: firmware-${{ github.sha }}
        path: |
          .pio/build/esp32dev/firmware.bin
          .pio/build/esp32dev/firmware.elf
        retention-days: 30

    - name: âœ… Build summary
      run: |
        echo "### ðŸŽ‰ Build Successful!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Firmware Size:**" >> $GITHUB_STEP_SUMMARY
        ls -lh .pio/build/esp32dev/firmware.bin >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
